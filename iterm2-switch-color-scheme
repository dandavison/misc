#!/usr/bin/env python
import os
import subprocess
import sys

# TODO: arrow keys
# UP = '\x1b[A'
# LEFT = '\x1b[D'
# RIGHT = '\x1b[C'
# DOWN = '\x1b[B'

LEFT = 'h'
DOWN = 'j'
UP = 'k'
RIGHT = 'l'


ITERM2_COLOR_SCHEMES_DIR = '/tmp/iTerm2-Color-Schemes'
SCHEMES_DIR = ITERM2_COLOR_SCHEMES_DIR + '/schemes'
SCHEMES = os.listdir(SCHEMES_DIR)
APPLY_SCRIPT = ITERM2_COLOR_SCHEMES_DIR + '/tools/preview.rb'

def error(msg):
    print >>sys.stderr, msg
    exit(1)


def warn(msg):
    print >>sys.stderr, msg


if os.getenv('TMUX'):
    error("Please detach from your tmux session before running this script.")


class Getch(object):
    """
    http://stackoverflow.com/questions/510357/python-read-a-single-character-from-the-user
    """
    def __init__(self):
        import tty, sys

    def __call__(self):
        import sys, tty, termios
        fd = sys.stdin.fileno()
        old_settings = termios.tcgetattr(fd)
        try:
            tty.setraw(sys.stdin.fileno())
            ch = sys.stdin.read(1)
        finally:
            termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
        return ch


getch = Getch()


def apply_color_scheme(scheme):
    subprocess.check_call([APPLY_SCRIPT, SCHEMES_DIR + '/' + scheme])

def fetch_iterm2_color_schemes_if_absent():
    # https://github.com/mbadolato/iTerm2-Color-Schemes
    if not os.path.exists(ITERM2_COLOR_SCHEMES_DIR):
        warn('Cloning iTerm2-Color-Schemes into %s' % ITERM2_COLOR_SCHEMES_DIR)
        subprocess.check_call(['git',
                               'clone',
                               'https://github.com/mbadolato/iTerm2-Color-Schemes.git',
                               ITERM2_COLOR_SCHEMES_DIR])


if __name__ == '__main__':
    fetch_iterm2_color_schemes_if_absent()

    i = 0
    while True:
        key = getch()
        if key in {LEFT, UP}:
            i -= 1
        elif key in {RIGHT, DOWN}:
            i += 1
        else:
            exit(0)
        scheme = SCHEMES[i]
        print i, scheme.split('.')[0]
        apply_color_scheme(scheme)
