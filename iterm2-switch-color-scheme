#!/usr/bin/env python
import os
import subprocess
import sys
import termios
import tty

# TODO: arrow keys
# UP = '\x1b[A'
# LEFT = '\x1b[D'
# RIGHT = '\x1b[C'
# DOWN = '\x1b[B'

LEFT = 'h'
DOWN = 'j'
UP = 'k'
RIGHT = 'l'


def error(msg):
    print >>sys.stderr, msg
    exit(1)


def warn(msg):
    print >>sys.stderr, msg


if os.getenv('TMUX'):
    error("Please detach from your tmux session before running this script.")


def fetch_iterm2_color_schemes_if_absent():
    # https://github.com/mbadolato/iTerm2-Color-Schemes
    iterm2_color_schemes_dir = '/tmp/iTerm2-Color-Schemes'
    if not os.path.exists(iterm2_color_schemes_dir):
        warn('Cloning iTerm2-Color-Schemes into %s' % iterm2_color_schemes_dir)
        subprocess.check_call(['git',
                               'clone',
                               'https://github.com/mbadolato/iTerm2-Color-Schemes.git',
                               iterm2_color_schemes_dir])
    return iterm2_color_schemes_dir


ITERM2_COLOR_SCHEMES_DIR = fetch_iterm2_color_schemes_if_absent()
SCHEMES_DIR = ITERM2_COLOR_SCHEMES_DIR + '/schemes'
SCHEMES = os.listdir(SCHEMES_DIR)
APPLY_SCRIPT = ITERM2_COLOR_SCHEMES_DIR + '/tools/preview.rb'


def apply_color_scheme(scheme):
    subprocess.check_call([APPLY_SCRIPT, SCHEMES_DIR + '/' + scheme])


def read_character():
    """
    http://stackoverflow.com/questions/510357/python-read-a-single-character-from-the-user
    """
    fd = sys.stdin.fileno()
    old_settings = termios.tcgetattr(fd)
    try:
        tty.setraw(sys.stdin.fileno())
        ch = sys.stdin.read(1)
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
    return ch


if __name__ == '__main__':

    print 'Use j/k to move through color themes'

    i = 0
    while True:
        key = read_character()
        if key in {LEFT, UP}:
            i -= 1
        elif key in {RIGHT, DOWN}:
            i += 1
        else:
            exit(0)
        scheme = SCHEMES[i]
        print i, scheme.split('.')[0]
        apply_color_scheme(scheme)
