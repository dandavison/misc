#!/usr/bin/env python
import os
import random
import subprocess
import sys
import termios
import tty

def error(msg):
    print >>sys.stderr, msg
    exit(1)


def warn(msg):
    print >>sys.stderr, msg


class ColorSchemeChooser(object):
    # TODO: arrow keys
    # UP = '\x1b[A'
    # LEFT = '\x1b[D'
    # RIGHT = '\x1b[C'
    # DOWN = '\x1b[B'

    DOWN = 'j'
    UP = 'k'

    def __init__(self, path='/tmp/iTerm2-Color-Schemes'):
        self.path = path
        self.schemes_dir = self.path + '/schemes'
        self.schemes = os.listdir(self.schemes_dir)
        self.blank = ' ' * max(len(s) for s in self.schemes)
        self.apply_script = self.path + '/tools/preview.rb'

        if not os.path.exists(self.path):
            warn('Cloning iTerm2-Color-Schemes into %s' % self.path)
            self.clone_color_schemes_repo()

    def run(self):

        print 'j/k to move through color themes'

        i = random.choice(range(len(self.schemes)))
        while True:
            key = read_character()
            if key == self.UP:
                i = (i - 1) % len(self.schemes)
            elif key == self.DOWN:
                i = (i + 1) % len(self.schemes)
            else:
                print
                exit(0)
            self.apply_scheme(i)
            self.print_scheme(i)

    def apply_scheme(self, i):
        scheme = self.schemes[i]
        subprocess.check_call([
            self.apply_script,
            self.schemes_dir + '/' + scheme,
        ])

    def print_scheme(self, i):
        sys.stdout.write("%s\r%3d %s\r" % (
            self.blank,
            i,
            self.schemes[i].split('.')[0]),
        )

    def clone_color_schemes_repo():
        subprocess.check_call([
            'git',
            'clone',
            'https://github.com/mbadolato/iTerm2-Color-Schemes.git',
            iterm2_color_schemes_dir,
        ])


def read_character():
    """
    http://stackoverflow.com/questions/510357/python-read-a-single-character-from-the-user
    """
    fd = sys.stdin.fileno()
    old_settings = termios.tcgetattr(fd)
    try:
        tty.setraw(sys.stdin.fileno())
        return sys.stdin.read(1)
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)


if __name__ == '__main__':

    if os.getenv('TMUX'):
        error("Please detach from your tmux session before running this script.")

    ColorSchemeChooser().run()
